---
import LiquidGlassLess from "@components/common/LiquidGlassLess.astro";
import { getEntries } from "@lib/contentParser";
import type { BlogEntry, PagesEntry } from "@/types";

const { limit = 8 } = Astro.props as { limit?: number };
const allPosts = (await getEntries("blog")) as BlogEntry[];
const pages = (await getEntries("pages")) as PagesEntry[];
const titleMap = Object.fromEntries(
  [...allPosts,...pages].map((p) => [p.id, p.data.title])
);
---

<section class="rounded-lg pt-3">
  <div class="flex items-center justify-between mb-4 px-3">
    <h3 class="text-xl font-bold text-txt-p dark:text-darkmode-txt-p">
      最近留言
    </h3>
  </div>
  <ul id="recent-comments-list" class="space-y-1"></ul>
</section>

<script define:vars={{
  twikooEnvId: import.meta.env.PUBLIC_TWIKOO_ENV_ID || "",
  limit,
  titleMap
}}>
  let list = document.getElementById("recent-comments-list");
  const maxLen=100;
  function showLoading(){
    if(!list) return;
    list.setAttribute('aria-busy','true');
    list.innerHTML = `
      <li class="py-4">
        <div class="flex items-center justify-center gap-2 text-slate-500 dark:text-slate-200">
          <span class="inline-block w-5 h-5 border-2 border-slate-400 border-t-transparent rounded-full animate-spin"></span>
          <span>正在加载留言…</span>
        </div>
      </li>
    `;
  }
  function showError(msg){
    if(!list) return;
    list.removeAttribute('aria-busy');
    list.innerHTML = `
      <li class="py-4">
        <div class="text-center text-red-600 dark:text-red-400">
          ${msg || "评论获取失败，请稍后重试。"}
        </div>
      </li>
    `;
    const btn = document.getElementById("rc-retry-btn");
    if(btn){ btn.addEventListener("click", load, { once: true }); }
  }
  function stripHtml(s){
    try{
      return (s||"").replace(/<[^>]*>/g,"").trim()
    }catch(e){
      console.error('stripHtml报错：',e)
      return "";
    }
  }
  function pathFromUrl(u){
    try{
      //根据/截取路径，获取最后一个路径段
      if(u.indexOf("/")!=-1){
        u=u.split("/")[u.split("/").length-1];
      }
      return decodeURIComponent(u)||u
    }catch(e){
      console.error('格式化路径报错：',e)
      return u;
    }
  }
  function ensureTwikoo(cb){
    if(window.twikoo){cb();return}
    const s=document.createElement("script");
    s.src="https://cdn.jsdmirror.com/npm/twikoo@1.6.44/dist/twikoo.min.js";
    s.async=true;
    s.onload=cb;
    document.body.appendChild(s);
  }
  function render(items){
    if(list){ list.removeAttribute('aria-busy'); }
    if(!list || !items || items.length==0) {
      //显示一个空提示
      list.innerHTML=`
        <li class="text-slate-500 dark:text-slate-200 text-center">还没有留言哦</li>
      `;
      return;
    }
    list.innerHTML="";
    items.forEach((it,index)=>{
      const url=it.url||it.link||"";
      const path=pathFromUrl(url);
      const title=titleMap[path]||path;
      const full=stripHtml(it.comment||it.content||"");
      const short=full.length>maxLen?full.slice(0,maxLen)+"…":full;
      const li=document.createElement("li");
      li.className="group rounded-[25px] hover:bg-primary/5 transition-all duration-300 intersect:animate-fadeUp opacity-0 p-3 hover:bg-orange-500 dark:hover:bg-orange-500 hover:text-darkmode-txt-light [&_*]:hover:text-darkmode-txt-p";
      li.style.animationDelay=`${index * 200}ms`;
      li.innerHTML=`
        <a class="no-underline hover:text-primary" href="${url}">
          <div class="text-txt-light dark:text-darkmode-txt-light flex items-center gap-2 mt-1 h-8">
            <span class="glass w-9 h-9 rounded-full overflow-hidden hover:rotate-12 duration-300">
              <img src="${it.avatar||it.avatarUrl||""}" alt="${it.nick||it.nickname||"匿名"}" class="w-9 h-9 rounded-full">
            </span>
            <div class="flex flex-col justify-center leading-tight h-8">
              <span class="text-base text-txt-p dark:text-darkmode-txt-p">${it.nick||"匿名"}</span>
              <span class="text-xs text-slate-500 dark:text-slate-200">${new Date(it.created||Date.now()).toLocaleString()}</span>
            </div>
          </div>
          <div class="text-[#3e5f6a] dark:text-darkmode-txt-p leading-7 line-clamp-2 font-semibold mt-3" title="${full.replace(/"/g,'&quot;')}">${short}</div>
          <div class="text-sm italic opacity-0 group-hover:opacity-100 text-slate-600 dark:text-slate-100/50 border-t border-slate-300/30 dark:border-darkmode-border/30 pt-1 text-right transition-opacity duration-300">
            来自：${title}
          </div>
        </a>
      `;
      list.appendChild(li);
    });
  }
  function load(){
    list = document.getElementById("recent-comments-list");
    if(!list){return}
    if(!twikooEnvId){
      showError("留言模块未加载，Twikoo envId 未配置。");
      return;
    }
    showLoading();
    ensureTwikoo(()=>{
      if(!window.twikoo){
        showError("评论系统初始化失败");
        return;
      }
      window.twikoo.getRecentComments({ envId: twikooEnvId, pageSize: limit })
        .then((res)=>{
          const arr=res?.comments||res||[];
          console.log('从twikoo获取评论列表',arr)
          render(arr);
        })
        .catch((err)=>{
          console.error('获取最近评论失败', err);
          showError("评论获取失败，请稍后重试。");
        });
    });
  }
  // document.addEventListener("DOMContentLoaded", load);
  document.addEventListener("astro:page-load", load);
  function ensureTwikoo(cb){
    if(window.twikoo){cb();return}
    const s=document.createElement("script");
    s.src="https://cdn.jsdmirror.com/npm/twikoo@1.6.44/dist/twikoo.min.js";
    s.async=true;
    s.onload=cb;
    s.onerror=()=>{
      showError("评论系统加载失败，请稍后重试。");
    };
    document.body.appendChild(s);
  }
</script>
