---
// 服务器端不再获取数据，改为客户端动态加载（本地 JSON）
---

<div class="friend-links-container">
  <!-- 友情链接统计 - 始终显示 -->
  <div class="mb-4 text-center">
    <p class="text-sm text-gray-600 dark:text-gray-400">
      共收录 <span
        id="total-count"
        class="font-semibold text-blue-600 dark:text-blue-400">0</span
      > 个友情链接
    </p>
  </div>

  <!-- 友链内容区域 -->
  <div class="friend-links-content">
    <!-- 加载状态 -->
    <div id="loading-state" class="text-center py-12">
      <div
        class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"
      >
      </div>
      <p class="text-gray-500 dark:text-gray-400">加载中...</p>
    </div>

    <!-- 错误状态 -->
    <div id="error-state" class="text-center py-12 hidden">
      <div class="text-red-400 dark:text-red-600 mb-4">
        <svg
          class="w-16 h-16 mx-auto"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"
          ></path>
        </svg>
      </div>
      <p class="text-red-500 dark:text-red-400 mb-2">加载友情链接失败</p>
      <button
        id="retry-btn"
        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
      >
        重试
      </button>
    </div>

    <!-- 友情链接分类列表 -->
    <div id="friend-links-categories" class="hidden">
      <!-- 分类和友链将通过 JavaScript 动态生成 -->
    </div>

    <!-- 空状态 -->
    <div id="empty-state" class="text-center py-12 hidden">
      <div class="text-gray-400 dark:text-gray-600 mb-4">
        <svg
          class="w-16 h-16 mx-auto"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"
          ></path>
        </svg>
      </div>
      <p class="text-gray-500 dark:text-gray-400">暂无友情链接</p>
    </div>
  </div>
</div>

<script>
  // @ts-nocheck
  // 友情链接数据和状态（本地 JSON）
  let categories = [];
  let friendLinks = [];

  // DOM 元素引用（纯 JS）
  let loadingState = document.getElementById("loading-state");
  let errorState = document.getElementById("error-state");
  let emptyState = document.getElementById("empty-state");
  let friendLinksCategories = document.getElementById("friend-links-categories");
  let retryBtn = document.getElementById("retry-btn");
  const totalCountEl = document.getElementById("total-count");

  // 显示状态
  function showLoading() {
    if (loadingState) loadingState.classList.remove("hidden");
    if (errorState) errorState.classList.add("hidden");
    if (friendLinksCategories) friendLinksCategories.classList.add("hidden");
    if (emptyState) emptyState.classList.add("hidden");
  }

  function showError() {
    if (loadingState) loadingState.classList.add("hidden");
    if (errorState) errorState.classList.remove("hidden");
    if (friendLinksCategories) friendLinksCategories.classList.add("hidden");
    if (emptyState) emptyState.classList.add("hidden");
  }

  function showContent() {
    if (loadingState) loadingState.classList.add("hidden");
    if (errorState) errorState.classList.add("hidden");
    if (friendLinksCategories) friendLinksCategories.classList.remove("hidden");
    if (emptyState) emptyState.classList.add("hidden");
  }

  function showEmpty() {
    if (loadingState) loadingState.classList.add("hidden");
    if (errorState) errorState.classList.add("hidden");
    if (friendLinksCategories) friendLinksCategories.classList.add("hidden");
    if (emptyState) emptyState.classList.remove("hidden");
  }

  // 从本地 JSON 获取友链数据
  async function fetchFriendLinks() {
    try {
      showLoading();

      const res = await fetch('/data/friends.json', { cache: 'no-store' });
      if (!res.ok) throw new Error('加载本地 friends.json 失败');
      const json = await res.json();

      categories = Array.isArray(json.categories) ? json.categories : [];
      friendLinks = Array.isArray(json.links) ? json.links : [];

      renderFriendLinks();
      showContent();
    } catch (error) {
      console.error("❌ 获取友情链接数据失败:", error);
      showError();
    }
  }

  // 渲染友情链接
  function renderFriendLinks() {
    // 更新统计
    if (totalCountEl) {
      totalCountEl.textContent = String(friendLinks.length);
    } else {
      console.error("❌ totalCountEl 元素未找到");
    }

    // 显示空状态或内容
    if (friendLinks.length === 0) {
      showEmpty();
    } else {
      showContent();
      // 渲染按分类列出的友情链接
      renderFriendLinksByCategory();
    }
  }

  // 按分类渲染友情链接
  function renderFriendLinksByCategory() {
    if (!friendLinksCategories) {
      return;
    }

    // 按分类分组友链
    const linksByCategory = {};
    friendLinks.forEach((link) => {
      const code = link && link.category_code ? link.category_code : 'default';
      if (!linksByCategory[code]) {
        linksByCategory[code] = [];
      }
      linksByCategory[code].push(link);
    });

    // 将分类按 sort_order 排序
    const sortedCategories = [...categories].sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0));

    // 生成分类和友链的 HTML
    let categoriesHTML = "";

    sortedCategories.forEach((category) => {
      const code = category && category.code ? category.code : 'default';
      const categoryLinks = (linksByCategory[code] || []).filter(l => l && l.status !== 'lost');
      if (categoryLinks.length === 0) return;

      categoriesHTML += `
        <div class="category-section mb-12">
          <h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-gray-200">
            ${category.name || ''}
            <span class="text-lg font-normal text-txt-light dark:text-darkmode-txt-light">(${String(categoryLinks.length)})</span>
          </h2>
          <div class="friends-grid grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            ${categoryLinks
              .map((link, index) => {
                const cardHtml = createFriendLinkCard(link, index);
                // 添加动画延迟
                return `<div class="friend-item" style="animation-delay: ${String(index * 0.1)}s">${cardHtml}</div>`;
              })
              .join("")}
          </div>
        </div>
      `;
    });

    friendLinksCategories.innerHTML = categoriesHTML;
  }

  // 创建友链卡片
  function createFriendLinkCard(link, index) {
    const name = link && link.name ? link.name : '';
    const url = link && link.url ? link.url : '#';
    const description = link && link.description ? link.description : '';
    const avatar = link && link.avatar ? link.avatar : '/favicon/logo-192x192.png';
    const status = link && link.status ? link.status : 'active';
    const responseTime = link && link.responseTime ? link.responseTime : null;

    // 计算响应时间颜色
    function getResponseTimeColor(time) {
      if (time === null) return 'text-gray-400';
      if (time < 500) return 'text-green-500';
      if (time < 1000) return 'text-yellow-500';
      if (time < 2000) return 'text-orange-500';
      return 'text-red-500';
    }

    // 格式化响应时间
    function formatResponseTime(time) {
      if (time === null) return '未知';
      if (time < 1000) return `${time}ms`;
      return `${(time / 1000).toFixed(1)}s`;
    }

    return `
      <div class="friend-card glass h-full rounded-[18px] overflow-hidden transition-all duration-300 group backdrop-blur-md relative">
        <a href="${url}" target="_blank" rel="external nofollow noopener noreferrer" class="block h-full p-4 no-underline">
          <div class="flex items-center space-x-3 h-full">
            <!-- 头像 -->
            <div class="flex items-center relative">
              <div class="friend-avatar relative w-16 h-16 rounded-full overflow-hidden ring-2 ring-primary/20 group-hover:ring-primary/40">
                <img src="${avatar}" alt="${name} 的头像" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" loading="lazy" onerror="this.src='/favicon/logo-192x192.png'" />
              </div>
              ${
                status === "active"
                  ? `
                  <div class="status-indicator top-5 right-2 w-4 h-4 bg-green-500 rounded-full border-2 border-white dark:border-gray-800 z-10" title="正常状态"></div>
                `
                  : status === "lost"
                    ? `
                  <div class="status-indicator top-5 right-2 w-4 h-4 bg-red-500 rounded-full border-2 border-white dark:border-gray-800 z-10" title="已丢失"></div>
                `
                    : status === "error"
                      ? `
                  <div class="status-indicator top-5 right-2 w-4 h-4 bg-red-500 rounded-full border-2 border-white dark:border-gray-800 z-10" title="连接错误"></div>
                `
                      : ""
              }
            </div>

            <!-- 内容区域 -->
            <div class="flex-1 min-w-0">
              <!-- 网站名称 -->
              <div class="flex items-center gap-2 mb-1">
                <h3 class="friend-name text-lg font-bold text-txt-p dark:text-darkmode-txt-p truncate group-hover:text-primary transition-colors duration-200">
                  ${name}
                </h3>
                ${responseTime !== null ? `
                  <span class="text-xs ${getResponseTimeColor(responseTime)}" title="响应时间">
                    ${formatResponseTime(responseTime)}
                  </span>
                ` : ''}
              </div>

              <!-- 网站描述 -->
              <p class="friend-description text-sm text-txt-light dark:text-darkmode-txt-light line-clamp-2 leading-relaxed">
                ${description}
              </p>
            </div>
          </div>

          <!-- 悬浮效果 -->
          <div class="absolute inset-0 bg-gradient-to-r from-primary/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 rounded-[18px]"></div>
        </a>
      </div>
    `;
  }

  // 重试按钮事件
  if (retryBtn) {
    retryBtn.addEventListener("click", fetchFriendLinks);
  }

  // 页面加载完成后获取数据
  document.addEventListener("DOMContentLoaded", () => {
    fetchFriendLinks();
  });

  // Astro 客户端路由事件监听
  document.addEventListener("astro:page-load", () => {
    // 重新获取 DOM 元素引用
    loadingState = document.getElementById("loading-state");
    errorState = document.getElementById("error-state");
    emptyState = document.getElementById("empty-state");
    friendLinksCategories = document.getElementById("friend-links-categories");
    retryBtn = document.getElementById("retry-btn");

    // 重新绑定重试按钮事件
    if (retryBtn) {
      retryBtn.addEventListener("click", fetchFriendLinks);
    }

    fetchFriendLinks();
  });

  // 页面可见性变化监听
  document.addEventListener("visibilitychange", () => {
    if (!document.hidden) {
      setTimeout(fetchFriendLinks, 200);
    }
  });

  // 平滑滚动到顶部功能
  window.scrollToTop = function () {
    window.scrollTo({ top: 0, behavior: "smooth" });
  };
</script>

<style>
  /* 全局平滑滚动 */
  html { scroll-behavior: smooth; }

  /* 友链网格样式 */
  .friends-grid { perspective: 1000px; }

  /* 友链项目动画 */
  .friend-item {
    animation: slideInUp 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    opacity: 0;
    transform: translateY(50px) rotateX(10deg);
  }

  /* 状态指示器样式 */
  :global(.status-indicator) { animation: pulse 1s infinite; position: relative; }
  :global(.status-indicator)::after {
    content: ""; position: absolute; top: 50%; left: 50%; width: 100%; height: 100%; border-radius: 50%; background: inherit; transform: translate(-50%, -50%); animation: ripple 1s infinite; opacity: 0.3;
  }

  @keyframes slideInUp {
    0% { opacity: 0; transform: translateY(50px) rotateX(10deg); }
    60% { opacity: 0.8; transform: translateY(-10px) rotateX(-2deg); }
    100% { opacity: 1; transform: translateY(0) rotateX(0deg); }
  }

  /* 统计信息动画 */
  .friends-stats { animation: fadeInDown 0.6s ease-out; }
  @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px);} to { opacity: 1; transform: translateY(0);} }

  /* 响应式优化 */
  @media (max-width: 768px) { .friends-grid { gap: 1rem; } .friend-item { animation-duration: 0.6s; } }

  /* 深色模式优化 */
  @media (prefers-color-scheme: dark) {
    .friends-section::before {
      background: linear-gradient(90deg, transparent, #4f46e5, #7c3aed, transparent);
    }
  }

  .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

  /* 友链卡片样式 */
  :global(.friend-card) {
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid rgba(255, 255, 255, 0.1);
    position: relative; overflow: hidden;
  }
  :global(.friend-card::before) { content: ""; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent); transition: left 0.4s ease; }
  :global(.friend-card:hover::before) { left: 100%; }
  :global(.friend-card:hover) { transform: translateY(-8px) scale(1.02); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2); border-color: rgba(255, 255, 255, 0.2); }

  /* 友链头像 */
  :global(.friend-card .friend-avatar) { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important; position: relative; }
  :global(.friend-card .friend-avatar::after) { content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0; border-radius: 50%; background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.2), transparent); opacity: 0; transition: opacity 0.4s ease; z-index: 1; }
  :global(.friend-card:hover .friend-avatar) { transform: scale(1.15) rotate(5deg) !important; }
  :global(.friend-card:hover .friend-avatar::after) { opacity: 1; }

  /* 名称、描述、链接样式保留 */
  :global(.friend-name) { transition: color 0.4s ease; }
  :global(.friend-card:hover .friend-name) { background: linear-gradient(45deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
  :global(.friend-description) { transition: transform 0.4s ease; }
  :global(.friend-card:hover .friend-description) { transform: translateY(-2px); }
  :global(.friend-url) { transition: all 0.4s ease; position: relative; overflow: hidden; }
  :global(.friend-url::before) { content: ""; position: absolute; bottom: 0; left: 0; width: 0; height: 1px; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.4s ease; }
  :global(.friend-card:hover .friend-url::before) { width: 100%; }

  @keyframes pulse { 0%,100%{opacity:1; transform:scale(1);} 50%{opacity:0.7; transform:scale(1.1);} }
  @keyframes ripple { 0% { transform: translate(-50%, -50%) scale(1); opacity: 0.3; } 100% { transform: translate(-50%, -50%) scale(2); opacity: 0; } }
</style>
