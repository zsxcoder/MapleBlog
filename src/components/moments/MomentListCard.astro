---
import { FaRegCalendarAlt, FaMapMarkerAlt, FaSmile } from "react-icons/fa";
import { formatDate } from "@lib/formatDate";
import LiquidGlass from "@components/common/LiquidGlassLess.astro";
import { markdownify } from "@lib/textConverter";
import '@fancyapps/ui/dist/fancybox/fancybox.css';
import { Fancybox } from '@fancyapps/ui';

interface Props {
  moment: {
    id: string;
    createdAt: string;
    message: string;
    tags: string[];
    isUseMarkdown?: boolean;
    location?: {
      placeholder?: string;
    };
  };
}

const { moment }: Props = Astro.props;
const { createdAt, message, tags, isUseMarkdown = false } = moment;
const content = message;

const entryDate = createdAt ? formatDate(new Date(createdAt)) : null;

// 强制处理Markdown内容，因为memos中的内容是Markdown格式
const renderedContent = await markdownify(content, true);

---

<LiquidGlass
  heavy
  wrapperClass="dock rounded-lg my-4 pl-0 bg-gradient-to-br gradient shadow-lg hover:shadow-xl hover:scale-[1.01]"
  textClass="h-full"
  animation="fadeRight"
>
  <div class="p-4">
    <!-- 作者信息和发布时间 -->
    <div class="flex items-center mb-4">
      <div
        class="w-10 h-10 rounded-full overflow-hidden bg-gray-200 dark:bg-gray-700"
      >
        <!-- 使用默认头像 -->
        <img
          src="https://home.zsxcoder.top/api/avatar.png"
          alt="钟神秀"
          class="w-full h-full object-cover"
        />
      </div>
      <div class="ml-3">
        <h4 class="font-bold">钟神秀</h4>
        <div class="flex items-center text-xs text-gray-700 dark:text-gray-400">
          {entryDate && (
            <span class="flex items-center">
              <FaRegCalendarAlt className="mr-1" />
              {entryDate}
            </span>
          )}
        </div>
      </div>
    </div>

    <!-- 内容区域 -->
    <div class="mb-4">
      <!-- 内容 -->
      <div class="mb-3">
        <div class="markdown-content" set:html={renderedContent} />
      </div>

      <!-- 标签 -->
      {tags && tags.length > 0 && (
        <div class="flex flex-wrap gap-2 ">
          {tags.map((tag) => (
            <a
              href={`/moments/tags/${tag}`}
              class="px-2 py-1 glass-l text-xs text-gray-900/50 rounded-full hover:bg-white/40 transition-colors duration-300 dark:text-gray-200/60"
              data-key={tag}
            >
              #{tag}
            </a>
          ))}
        </div>
      )}

      <!-- 位置信息 -->
      {moment.location && moment.location.placeholder && (
        <div class="mt-3 flex items-center text-xs text-gray-600 dark:text-gray-400">
          <FaMapMarkerAlt className="mr-1" />
          <span>{moment.location.placeholder}</span>
        </div>
      )}
    </div>
  </div>
</LiquidGlass>

<script>
  import { initCopyButtons } from '@lib/markdownUtils';
  import { Fancybox } from '@fancyapps/ui';

  // 在DOM加载完成后初始化功能
  if (typeof window !== 'undefined') {
    // 等待DOM加载完成
    document.addEventListener('DOMContentLoaded', function() {
      // 手动初始化复制按钮功能，因为内容是动态渲染的
      initCopyButtons();

      // 移除可能存在的其他灯箱事件监听器
      const images = document.querySelectorAll('.markdown-image img');
      images.forEach(img => {
        // 移除所有点击事件监听器
        const clone = img.cloneNode(true);
        img.parentNode?.replaceChild(clone, img);
      });

      // 重新获取图片元素并添加fancybox灯箱功能
      const newImages = document.querySelectorAll('.markdown-image img');
      newImages.forEach(img => {
        // 添加data-fancybox属性
        img.setAttribute('data-fancybox', 'gallery');
        // 设置图片标题
        const imgElement = img as HTMLImageElement;
        if (imgElement.alt) {
          imgElement.setAttribute('data-caption', imgElement.alt);
        }
      });

      // 初始化fancybox前确保清理
      try {
        // 销毁可能存在的实例
        Fancybox.destroy();
      } catch (e) {
        // 忽略错误
      }

      // 初始化fancybox
      Fancybox.bind('[data-fancybox="gallery"]', {
        // 配置选项
        animationEffect: 'zoom', // 动画效果
        transitionEffect: 'slide', // 过渡效果
        buttons: [
          'zoom',
          'fullScreen',
          'thumbs',
          'close'
        ],
        toolbar: true,
        infinite: true,
        keyboard: 'auto',
        clickContent: 'zoom',
        clickSlide: 'close',
        // 防止双击放大
        doubleClick: 'zoom',
        // 确保只有一个实例
        groupAll: false
      });
    });
  }
</script>
