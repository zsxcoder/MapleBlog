<style>
    /* Liquid glass effect */
    #post-update-notification > div {
        backdrop-filter: blur(16px) saturate(180%);
        -webkit-backdrop-filter: blur(16px) saturate(180%);
    }
</style>

<div id="post-update-notification" class="fixed top-20 right-4 z-50 transform translate-x-full opacity-0 transition-all duration-300 pointer-events-none">
    <div class="bg-blue-100/80 dark:bg-blue-900/40 border border-blue-300 dark:border-blue-700 rounded-xl shadow-lg p-4 max-w-sm relative pointer-events-auto flex flex-col gap-2">
        <div class="flex items-center gap-2 text-blue-600 dark:text-blue-300">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>
            <span class="font-bold text-sm">内容已更新</span>
        </div>
        <p class="text-xs text-[var(--text-main)] opacity-80">检测到文章内容有变化，已为您高亮差异部分。</p>
        <div class="flex gap-2 mt-1">
            <button id="scroll-to-diff" class="px-3 py-1 bg-[var(--admonitions-color-tip)] text-white rounded text-xs hover:opacity-90 transition-opacity">
                跳转到更新处
            </button>
            <button id="close-diff-toast" class="px-3 py-1 bg-transparent border border-[var(--line-divider)] text-[var(--text-main)] rounded text-xs hover:bg-[var(--btn-regular-bg-hover)] transition-colors">
                忽略
            </button>
        </div>
    </div>
</div>

<script>
    import * as Diff from 'diff';

    // Helper to get pure text content from markdown container
    function getContentText() {
        const container = document.querySelector('.markdown-content');
        return container ? container.textContent || '' : '';
    }

    // Helper to store content hash/text
    const STORAGE_PREFIX = 'mapleblog-post-content-cache-';

    async function initDiffCheck() {
        // Only run on post pages
        const postContainer = document.getElementById('post-container');
        if (!postContainer) return;

        const currentPath = window.location.pathname;
        const storageKey = STORAGE_PREFIX + currentPath;
        const currentText = getContentText();

        // Developer Mode Check
        const urlParams = new URLSearchParams(window.location.search);
        const isDevMode = urlParams.has('debug-diff');

        if (isDevMode) {
            console.log('[Diff] Developer mode active');
            // Mock old text by removing a random paragraph or adding dummy text
            const paragraphs = currentText.split('\n\n');
            // Simulate that the middle paragraph is new
            const middleIndex = Math.floor(paragraphs.length / 2);
            const oldText = paragraphs.filter((_, i) => i !== middleIndex).join('\n\n');

            highlightDiff(oldText, currentText);
            return;
        }

        const cachedText = localStorage.getItem(storageKey);

        if (!cachedText) {
            // First visit, cache current text
            localStorage.setItem(storageKey, currentText);
        } else if (cachedText !== currentText) {
            // Content changed
            console.log('[Diff] Content change detected');
            highlightDiff(cachedText, currentText);
            // Update cache
            localStorage.setItem(storageKey, currentText);
        }
    }

    function highlightDiff(oldText: string, newText: string) {
        if (!oldText || !newText) return;
        
        const diff = Diff.diffWords(oldText, newText);
        const container = document.querySelector('.markdown-content');
        if (!container) return;

        // We can't easily replace the HTML because it would break structure/components/images
        // Strategy: Find the first significant added text chunk and scroll to it/highlight it via a Range/Mark
        // But since we are in a static site, the DOM structure might have changed significantly.
        // A safer visual approach for this specific request "highlight updates":
        // Since we cannot reliably reconstruct the HTML from the Diff output without a complex parser,
        // we will try to match the text node in the DOM.

        // Filter for added parts that are significant (e.g., > 10 chars) to avoid noise
        const addedParts = diff.filter(part => part.added && part.value.trim().length > 10);

        if (addedParts.length === 0) return;

        // Show Notification
        const notification = document.getElementById('post-update-notification');
        if (notification) {
            notification.classList.remove('translate-x-full', 'opacity-0', 'pointer-events-none');

            document.getElementById('close-diff-toast')?.addEventListener('click', () => {
                notification.classList.add('translate-x-full', 'opacity-0', 'pointer-events-none');
            });

            document.getElementById('scroll-to-diff')?.addEventListener('click', () => {
                scrollToFirstDiff(addedParts[0].value);
            });
        }
    }

    function scrollToFirstDiff(textToFind: string) {
        if (!textToFind) return;
        
        // Try to find the text node containing this text
        // This is a naive implementation; complex markdown structures might split text across nodes
        // But for a "jump to" feature it often suffices to find a substring

        const container = document.querySelector('.markdown-content');
        if (!container) return;

        // Clean up search text (remove newlines, extra spaces)
        const searchStr = textToFind.trim().substring(0, 50); // Search for the first 50 chars

        const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT, null);
        let node;
        while (node = walker.nextNode()) {
            if (node.textContent && node.textContent.includes(searchStr)) {
                // Found it!
                const range = document.createRange();
                range.selectNodeContents(node);
                const rect = range.getBoundingClientRect();

                // Highlight
                const span = document.createElement('span');
                span.style.backgroundColor = 'rgba(255, 255, 0, 0.3)';
                span.style.transition = 'background-color 1s';
                span.className = 'diff-highlight-flash';

                // Wrap the text node (careful not to break DOM if possible, but this is a leaf text node)
                // For safety, let's just scroll parent into view and add a class
                const parent = node.parentElement;
                if (parent) {
                    parent.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    parent.classList.add('animate-pulse'); // Tailwind pulse
                    setTimeout(() => parent.classList.remove('animate-pulse'), 2000);
                }

                return;
            }
        }
    }

    // Initialize on load and swup navigation
    document.addEventListener('DOMContentLoaded', initDiffCheck);
    document.addEventListener('swup:contentReplaced', initDiffCheck);

</script>
