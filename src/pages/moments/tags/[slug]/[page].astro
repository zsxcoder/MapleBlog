---
import CollectionLayout from "@components/moments/CollectionLayout.astro";
import { getPageSize } from "@lib/config";

// 获取笔记每页显示数量
const entriesPerPage = getPageSize('notes'); // 复用博客的分页配置

// 定义类型
interface Moment {
  id: string;
  createdAt: string;
  content: string;
  tags: string[];
}

// 生成所有标签页面的静态路径
export async function getStaticPaths() {
  // 从API获取moments数据
  const apiUrl = "https://mm.zsxcoder.top/public/notes";

  // 获取笔记每页显示数量
  const entriesPerPage = getPageSize('notes'); // 复用博客的分页配置

  // 定义内部函数获取所有标签
  async function getAllTags(): Promise<string[]> {
    try {
      const response = await fetch(apiUrl);
      if (response.ok) {
        const moments = await response.json() as Moment[];
        const tagSet = new Set<string>();
        moments.forEach((moment: Moment) => {
          moment.tags.forEach((tag: string) => tagSet.add(tag));
        });
        return Array.from(tagSet) as string[];
      }
    } catch (error) {
      console.error("获取tags数据出错:", error);
    }
    return [];
  }

  // 定义内部函数获取当前标签的moments
  async function getMomentsByTag(tag: string) {
    try {
      const response = await fetch(apiUrl);
      if (response.ok) {
        const moments = await response.json() as Moment[];
        const filtered = moments.filter((moment: Moment) =>
          moment.tags.includes(tag)
        );
        // 按创建时间排序
        filtered.sort((a: Moment, b: Moment) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());
        return {
          moments,
          filteredMoments: filtered,
          allMomentsCount: filtered.length
        };
      }
    } catch (error) {
      console.error("获取moments数据出错:", error);
    }
    return {
      moments: [],
      filteredMoments: [],
      allMomentsCount: 0
    };
  }

  const allTags = await getAllTags();

  // 为每个标签生成所有可能的分页路径
  const paths = [];

  for (const tag of allTags) {
    const { filteredMoments: tagMoments } = await getMomentsByTag(tag);
    const pageCount = Math.ceil(tagMoments.length / entriesPerPage);

    // 为每个标签的每一页生成路径
    for (let page = 1; page <= pageCount; page++) {
      paths.push({
        params: { slug: tag, page: page.toString() },
        props: { tag, page }
      });
    }
  }

  return paths;
}

// 定义外部函数获取所有标签
async function getAllTags(): Promise<string[]> {
  // 从API获取moments数据
  const apiUrl = "https://mm.zsxcoder.top/public/notes";

  try {
    const response = await fetch(apiUrl);
    if (response.ok) {
      const moments = await response.json() as Moment[];
      const tagSet = new Set<string>();
      moments.forEach((moment: Moment) => {
        moment.tags.forEach((tag: string) => tagSet.add(tag));
      });
      return Array.from(tagSet) as string[];
    }
  } catch (error) {
    console.error("获取tags数据出错:", error);
  }
  return [];
}

// 定义外部函数获取当前标签的moments
async function getMomentsByTag(tag: string) {
  // 从API获取moments数据
  const apiUrl = "https://mm.zsxcoder.top/public/notes";

  try {
    const response = await fetch(apiUrl);
    if (response.ok) {
      const moments = await response.json() as Moment[];
      const filtered = moments.filter((moment: Moment) =>
        moment.tags.includes(tag)
      );
      // 按创建时间排序
      filtered.sort((a: Moment, b: Moment) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());
      return {
        moments,
        filteredMoments: filtered,
        allMomentsCount: filtered.length
      };
    }
  } catch (error) {
    console.error("获取moments数据出错:", error);
  }
  return {
    moments: [],
    filteredMoments: [],
    allMomentsCount: 0
  };
}

// 获取当前标签和页码
const { tag, page } = Astro.props;
const currentTag = tag;
const currentPageIndex = page;

const { moments: allMoments, filteredMoments: tagMoments, allMomentsCount: tagMomentsCount } = await getMomentsByTag(currentTag);

// 计算当前页的内容
const indexOfLastEntry = currentPageIndex * entriesPerPage;
const indexOfFirstEntry = indexOfLastEntry - entriesPerPage;
const currentEntries = tagMoments.slice(indexOfFirstEntry, indexOfLastEntry).map(moment => ({
  id: moment.id,
  createdAt: moment.createdAt,
  message: moment.content,
  tags: moment.tags,
  isUseMarkdown: true
}));

// 计算总页数
const pageCount: number = Math.ceil(tagMoments.length / entriesPerPage);

// 获取所有标签用于页面导航
const tags = await getAllTags();

// 处理无效标签
if (currentTag && !tags.includes(currentTag)) {
  return Astro.redirect('/moments/tags');
}

// 处理无效页码
if (currentPageIndex < 1 || (pageCount > 0 && currentPageIndex > pageCount)) {
  return Astro.redirect(`/moments/tags/${currentTag}`);
}
---

<CollectionLayout
  entries={currentEntries}
  tags={tags}
  pageIndex={currentPageIndex}
  pageCount={pageCount}
  allMomentsCount={tagMomentsCount}
  basePath={`/moments/tags/${currentTag}`}
/>
